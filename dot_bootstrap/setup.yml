---
- name: Setup Environment
  hosts: localhost
  tasks:
    - name: Get my user
      ansible.builtin.set_fact:
        remote_regular_user: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"

    - name: Debug ansible_os_family
      debug:
        msg: "OS Family: {{ ansible_os_family }}"

    - name: Install dependencies
      become: yes
      package:
        name: "{{ item }}"
        state: present
      loop:
        - bash
        - bash-completion
        - tar
        - bat
        - tree
        - multitail
        - wget
        - unzip
        - fontconfig
        - neovim
        - ripgrep
        - btop
        - git
        - tmux
        - zsh
      when: ansible_os_family != 'Arch'

    - name: Install AUR helper and dependencies (Arch-based)
      block:
        - name: Install yay
          git:
            repo: https://aur.archlinux.org/yay-git.git
            dest: /opt/yay-git
            clone: yes
          become: yes

        - name: Build and install yay
          command: |
            cd /opt/yay-git && makepkg --noconfirm -si
          become: yes

        - name: Install dependencies using yay
          command: yay --noconfirm -S bash bash-completion tar bat tree fastfetch wget unzip fontconfig neovim tmux zsh git btop ripgrep lsd
          become: yes

      when: ansible_os_family == 'Arch'

    - name: Change shell to zsh
      ansible.builtin.user:
        name: "{{ remote_regular_user }}"
        shell: /usr/bin/zsh

    - name: Install Fzf
      block:
        - name: Install Fzf
          git:
            repo: https://github.com/junegunn/fzf.git
            dest: "{{ ansible_env.HOME }}/.fzf"
            clone: yes

        - name: Run Fzf install script
          command: "{{ ansible_env.HOME }}/.fzf/install"
          args:
            executable: /bin/bash
          become: yes

    - name: Install Zoxide
      shell: |
        curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh
      args:
        executable: /bin/bash

    - name: Install JetBrainsMono Nerd Font
      block:
        - name: Ensure fonts directory
          ansible.builtin.file:
            path: "~{{ remote_regular_user }}/.fonts"
            state: directory
            mode: "0755"
            owner: "{{ remote_regular_user }}"

        - name: Check if Jetbrains Mono exists
          ansible.builtin.shell: "ls ~{{ remote_regular_user }}/.fonts/JetBrainsMonoNerd*FontMono*"
          register: jetbrains_mono_exists
          ignore_errors: true
          changed_when: false

        - name: Download Jetbrains mono
          when: jetbrains_mono_exists is failed
          ansible.builtin.unarchive:
            src: https://github.com/ryanoasis/nerd-fonts/releases/download/v3.1.1/JetBrainsMono.zip
            dest: "~{{ remote_regular_user }}/.fonts/"
            remote_src: true
            mode: "0755"
            owner: "{{ remote_regular_user }}"
